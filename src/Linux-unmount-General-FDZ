#################################################
# Linux-unmount-General-FDZ
# Version: 0.4
#################################################
# (c) Copyright 2017 Hewlett Packard Enterprise Development LP
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software distributed
# under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
# CONDITIONS OF ANY KIND, either express or implied. See the License for the
# specific language governing permissions and limitations under the License.

# The following 4 echo commands are executed by the guestfish shell.
# Their output goes in the OS-Volume Activity log file.
echo "======================================="
echo "Linux-unmount-General-FDZ"
echo "======================================="
echo "Program the restore of the original RC file as last line of the ImageStreamer modified RC file"

# The following echo command is executed by the Image Streamer shell.
# Its output is appended to the RC file already present in the Image Streamer.
# Its goal is to tell RC-FILE to restore its backup file when executed during the
# first reboot of the OS-Volume.
#!echo "mv -f /etc/rc.d/rc.local.backup /etc/rc.d/rc.local" >> ./RC-FILE
<!awk '/rhel/ || /centos/ {print "!echo mv -f /etc/rc.d/rc.local.backup /etc/rc.d/rc.local >>./RC-FILE"} ; /sles/ {print "!echo mv -f /etc/init.d/after.local.backup /etc/init.d/after.local >> ./RC-FILE"}' ./OS-Type


# The following echo command is executed by the guestfish shell
# Its output goes in the OS-Volume Activity log.

echo "Copy-in the modified RC file"
# The following command copies the modified rc.local file from 
# the Image Streamer into the OS-Volume.
#upload ./rc.local /etc/rc.d/rc.local
<!awk '/rhel/ || /centos/ {print "upload ./RC-FILE /etc/rc.d/rc.local"} ; /sles/ {print "upload ./RC-FILE /etc/init.d/after.local" }' ./OS-Type


echo "Add the execute protection to the modified RC file"
<!awk '/rhel/ || /centos/ {print "chmod 0755 /etc/rc.d/rc.local"} ; /sles/ {print "chmod 0755 /etc/init.d/after.local" }' ./OS-Type

# The following echo commands is executed by the guestfish shell
# Its output goes into the OS-Volume Activity log.
echo "Copy in the saved backup of original RC filel"

# The following command copies rc.local.backup file from the Image Streamer 
# into the OS-Volume.
#upload ./rc.local.backup /etc/rc.d/rc.local.backup
<!awk '/rhel/ || /centos/ {print "upload ./RC-FILE.backup /etc/rc.d/rc.local.backup"} ; /sles/ {print "upload ./RC-FILE.backup /etc/init.d/after.local.backup" }' ./OS-Type


# The following 5 commands are executed by the guestfish shell.
# Their output goes in the OS-Volume Activity log file.
echo "#### This is the content of the rc.local file that will be executed during next reboot:"
echo "cat RC file"
!cat ./RC-FILE
echo "#### End of the RC file that will be executed during the next reboot"
echo "Removal of the temporary directory created in the OS-Volume"

# Uncomment the following line if you want guestfish to remove the entire
# temporary directory created in the OS-Volume.
# rm-rf /temp/ImageStreamer

# The following commands are executed by the guestfish shell. 
# Their output goes in the OS-Volume Activity log file.
echo "unmount all guestfish mounted partition(s)"
unmount-all

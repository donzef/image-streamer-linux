# Plan Script Description:
# Configure hostname and populate the network directory with ifcfg-* files and 
# /etc/hosts. NOTE: This script MUST be executed after the 
# Linux-configure-multiple-NICs-Deploy Plan Script. NOTE: The hostname is 
# associated to the IP address of the first discovered NIC, which is shell 
# variable iface=${array[0]}) NOTE: Not suitable for XenServer

# ############################################
# Linux-configure-hostname-DeployPS-FDZ
# Version: 0.53
# ############################################
# (c) Copyright 2017 Hewlett Packard Enterprise Development LP
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software distributed
# under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
# CONDITIONS OF ANY KIND, either express or implied. See the License for the
# specific language governing permissions and limitations under the License.

# The output of the following 4 guestfish echo commands goes
# to the OS-Volume Activity log.
echo
echo "======================================="
echo "Linux-configure-hostname-DeployPS-FDZ"
echo "======================================="
echo "\tManual configuration of /etc/hostname"

# The following guestfish upload command populates
# the OS-Volume /etc/hostname file.
upload -<<END /etc/hostname
@HostName@.@DomainName@
END

# The output of the following guestfish echo command goes in the
# OS-Volume Activity log file.
echo "\tEdit /etc/sysconfig/network file to set the HOSTNAME variable"

# The following guestfish upload command populates the 
# OS-Volume network file. In case of SUSE and Ubuntu, we will get an error
# because /etc/sysconfig/network is a directory already present or does not exists. 
# Hence we add the "-" to the upload command to avoid a
# bad exit of guestfish.
-upload -<<END /etc/sysconfig/network

# This file has been altered by Image Streamer.

NETWORKING=yes
HOSTNAME=@HostName@.@DomainName@

END

# The output of the following guestfish echo command goes
# in the OS-Volume Activity log file.
echo "\tPreparation of the script that will add the right entry in /etc/hosts" 

# The following bash script goes in the OS-Volume /temp/configure-hosts file.
# It will be executed during next reboot 
upload -<<END /temp/configure_hosts
#!/bin/bash

# This script requires the /temp/interface_names file generated by the
# Linux-configure-multiple-NICs plan script. 

# The output of the following echo command (name of this script)
# goes into the OS log file (i.e. /var/log/messages).
echo "Entering ${0}..."

if [ ! -f /temp/interface_names ]; then
 echo -e '\tCould not find file /temp/interface_names.
\tThis script must be launched after the NICs configuration.
\tCannot update /etc/hosts with hostname. Exiting...'
 exit 2
fi

# This script requires all the NICs operational.
# However, the execution time of this script during the
# boot process is not predictable because launched asynchronously by rc.local.
# We will wait until NICs are configured and exit after a timeout.

echo "Adding a hostname record in /etc/hosts if possible"
let timeout=60
let i=1
ifaces=`cat /temp/interface_names`
echo "Interface_names: $ifaces"
#rm -f /temp/interface_names
read -r -a array <<< $ifaces
iface=${array[0]}

while [ $i -lt $timeout ] ; do
 ip_address=`ip a list $iface | awk '/inet / {split($2, array, "/" ); print array[1]}' `
 if [ -z $ip_address ] ; then
 #echo "Length of ip_address is still 0"
 sleep 1
 let ++i
 else
 break
 fi
done

# Remove this script and exit if timeout is reached, 
if [ -z $ip_address ] ; then
 echo "Could not retrieve the IPv4 addresse of $iface. Exiting"
 # The following command deletes the current script.
 unlink $0
 exit 2
fi

# The output of the following echo command goes
# in the OS log file. Typically /var/log/messages.
echo "populating /etc/hosts with $ip_address (found after $i seconds..)."

fqdn=@HostName@.@DomainName@
# ToDo: Adapt the following to insert the comment after "ff02::2"
alias=$(echo ${fqdn%%.*} )
sed -i "/::1/a\\$ip_address $fqdn $alias" /etc/hosts
sed -i "/::1/a\\#This file has been altered by Image Streamer." /etc/hosts

# The output of the following bash command goes in 
# the OS log file. Typically /var/log/messages.
echo "Exting ${0}..."

# The following command deletes the current script
unlink $0
END

# The output of the following guestfish command goes
# in the OS-Volume Activity log file.
echo " Add the generated configure_hosts script to the RC file to run at boot time."

# The following Image Streamer echo command appends
# a line in the already present RC file.
!echo "/bin/bash /temp/configure_hosts" >> ./RC-FILE

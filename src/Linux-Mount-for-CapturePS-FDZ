# ###########################################
# Linux-Mount-for-CapturePS-FDZ
# Version: 0.5
############################################
# (c) Copyright 2017 Hewlett Packard Enterprise Development LP
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software distributed
# under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
# CONDITIONS OF ANY KIND, either express or implied. See the License for the
# specific language governing permissions and limitations under the License.

# NOTE: The output of guestfish commands goes to the Golden Image
# Activity log file ONLY if the first mount command is successful.
# If the first mount command fails, you must check the
# Image Streamer Activity log file to understand why
# the first mount command failed.



# The output of the following guestfish echo commands goes into
# The Golden Image Activity log file.
echo "======================================="
echo "Linux-Mount-for-CapturePS-FDZ"
echo "======================================="

# Un-comment the following guestfish commands if you need them.
# They list respectively the Volume Group and lvols present
# in the Golden image.
#Their output goes into the Golden Image Activity log file.
#vgs
#lvs

# The output of the following 2 guestfish commands 
# goes into the Golden Image Activity log file.
# The list-filesystems guestfish command lists all the file systems
# found in the Golden Image as well as their types (i.e. ext4).
# We issue this command mostly for debug purposes.
echo "List file systems:" 
list-filesystems
echo

# The following list-filesystems is a guestfish command.
# However, the cat command following the | (pipe) sign
# is executed by the Image Streamer shell. Hence, the overall output
# goes into the list-fs file in the Image Streamer.
list-filesystems | cat > list-fs

# Search for the OS device. The output of the 
# inspect-os guestfish command goes out, into a file in the 
# Image Streamer. 
inspect-os | cat > ./OS-Dev

# Print ./OS-Dev for debug purposes:
echo "Content of the OS Device file:"
!cat ./OS-Dev
echo


# NOTE: The following is a dirty fix of a potentially buggy inspect-os 
# returning more than one OS in the Golden Image. Basically, we noticed that 
# guestfish incorrectly proposes the vfat/UEFI partition 
# as an OS. Hence we remove the vfat partition from the 
# ./OS-Dev file:
# TBD: Verify that this command still works in Image Streamer 5.0 which running a more
# recent version of guestfish.
!if [ $(cat ./OS-Dev | wc -l) -eq 2 ] ;then VFAT_DEV=$(awk -F ":" '/vfat/ {print $1}' list-fs); awk -v vfat_dev=$VFAT_DEV '$0 != vfat_dev {print $0}' ./OS-Dev > ./OS-Dev2 ; mv ./OS-Dev2 ./OS-Dev ; fi

# Create the mount command and execute it. The !awk 
# command is executed by the Image Streamer. It prints
# the mount command in the Golden Image Activity log file.
# The "<" sign tells guestfish to execute the mount command.
echo "Mount Command:"

# Print the mount command for debug purposes in the Golden Image Activity log file:
!awk '/dev/ {print "mount", $0, "/"}' ./OS-Dev

# Perform the mount command:
<!awk '/dev/ {print "mount", $0, "/"}' ./OS-Dev

# Retrieve the OS type.
# The following "cat" command is executed by the guestfish shell. It sends 
# its output to the Image Streamer "awk" command which extracts the 
# ID property containing the OS Type. The output of the awk command
# goes into the ./OS-Type in the Image Streamer.
# The OS-Type is useful to distinguish Red Hat and SUSE specificity.
# NOTE: It should be possible to use the guestfish inspect-get-distro
# command to do the same.
cat /etc/os-release | awk -F '"' '/^ID=/ {print $2}' > ./OS-Type

# Print OS type for debug purposes
echo "Detected OS type"
!cat ./OS-Type
echo

# The following guestfish command creates temporary directory
# in the Golden Image.
-mkdir-p /temp/ImageStreamer

# Pull of the ./OS-Type from the Image Streamer
# to the temporary directory:
upload ./OS-Type /temp/OS-Type
